
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://clux.github.io/probes.zola/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://clux.github.io/probes.zola/abridge.css?h=5cd2e708e811917bd981" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://clux.github.io/probes.zola" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://clux.github.io/probes.zola/manifest.min.json" />
  <link rel="mask-icon" href="https://clux.github.io/probes.zola/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://clux.github.io/probes.zola/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://clux.github.io/probes.zola/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://clux.github.io/probes.zola/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://clux.github.io/probes.zola/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="probes Atom/RSS Feed" href="https://clux.github.io/probes.zola/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>shipcat introduction | probes</title>
  <meta name="author" content="clux" />
  <meta name="copyright" content="probes" />
  <meta name="description" content="Building a secure yaml api for kubernetes" />
  <link rel="canonical" href="https://clux.github.io/probes.zola/shipcat-introduction/" />
  <meta name="keywords" content="Kubernetes, Cloud, Rust, Theorycraft, Blog" />
  <script defer src="https://clux.github.io/probes.zola/js/abridge.min.js?h=52ceec8ac36fe25defe7" integrity="sha384-H1IaFs2MvG0ayi+Bq0d66Ih118nLUFESwUke1UH1uKzTiJwcgE8hXpONzAG3kqHj"></script>
  <noscript><link rel="stylesheet" href="https://clux.github.io/probes.zola/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><h1><a href="https://clux.github.io/probes.zola" title="probes">Probes</a></h1></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://clux.github.io/probes.zola/about/"> About </a></li><li><a class="s110" href="https://clux.github.io/probes.zola/"> Posts </a></li><li><a class="s110" href="https://clux.github.io/probes.zola/categories/"> Categories </a></li><li><a class="s110" href="https://clux.github.io/probes.zola/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main>
    <article>
      <h1><a href="https://clux.github.io/probes.zola/shipcat-introduction/">shipcat introduction</a></h1>

      <span class="s95"> clux <span class="rpad"></span> December 15, 2018 <span class="rpad"></span> [<a href="https://clux.github.io/probes.zola/categories/software/">software</a>] #<a href="https://clux.github.io/probes.zola/tags/rust/">rust</a>  #<a href="https://clux.github.io/probes.zola/tags/kubernetes/">kubernetes</a> </span>

    


<p>At <a rel="noopener" target="_blank" href="https://www.babylonhealth.com/">babylon health</a> we have a ton of microservices running on kubernetes that are, in turn, controlled by <strong>hundreds of thousands of lines</strong> of autogenerated <code>yaml</code>.</p>
<p>So for our own sanity, we built <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat"><code>shipcat</code></a> - a standardisation tool (powered by <a rel="noopener" target="_blank" href="https://www.rust-lang.org/">rust-lang</a> and <a rel="noopener" target="_blank" href="https://serde.rs/">serde</a>) to control the declarative format and lifecycle of every microservice.</p>
<!--more-->
<p>..but first, a bit about the problem:</p>
<h2 id="kubernetes-api">Kubernetes API</h2>
<p>Deploying services to kubernetes is no easy task. The abstraction might be <em>nice</em> once you've wrapped your head around it, but it's a significant mental overhead for hundreds of engineers to have to understand. Try telling every engineer that they all need to hand craft their <code>yaml</code> for whatever they need of:</p>
<ul>
<li><code>ConfigMap</code></li>
<li><code>Secrets</code></li>
<li><code>Deployment</code> / <code>ReplicaSet</code> / <code>Pod</code></li>
<li><code>Service</code></li>
<li><code>HorizontalPodAutoscaler</code></li>
<li><code>ServiceAccount</code></li>
<li><code>Role</code></li>
<li><code>RoleBinding</code></li>
<li><code>Ingress</code></li>
</ul>
<p>and you'll quickly realize that this does not scale. Your engineers maybe be able to handle it, but they shouldn't all have to deal with this excessively verbose API which lacks in crucial validation. Instead, creating a standard gives your platform internal consistency and makes it easier to upgrade manage.</p>
<h2 id="helm">Helm</h2>
<p>One of the main abstraction attempts kubernetes has seen in this space is <code>helm</code>. A client side templating system (ignoring the bad server side part) that lets you abstract away much of the above into <code>charts</code> (a collection of <code>yaml</code> go templates) ready to be filled in with <code>helm values</code>; the more concise <code>yaml</code> that developers write directly.</p>
<p>Simplistic usage of <code>helm</code> would involve having a <code>charts</code> folder:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">charts</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└──</span></span><span class="z-meta z-function-call z-arguments z-shell"> base</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">├──</span></span><span class="z-meta z-function-call z-arguments z-shell"> Chart.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">├──</span></span><span class="z-meta z-function-call z-arguments z-shell"> templates</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── configmap.yamls</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── deployment.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── hpa.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── rbac.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── secrets.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── serviceaccount.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   └── service.yaml</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└──</span></span><span class="z-meta z-function-call z-arguments z-shell"> values.yaml</span>
</span></code></pre>
<p>and calling it with your substitute <code>myvalues.yaml</code>:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">helm</span></span><span class="z-meta z-function-call z-arguments z-shell"> template charts/base myapp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> myvalues.yaml</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">kubectl</span></span><span class="z-meta z-function-call z-arguments z-shell"> apply<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>lapp</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>myapp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>prune</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> -</span>
</span></code></pre>
<p>which will garbage collect older kube resources with the <code>myapp</code> label, and start any necessary rolling upgrades in kubernetes.</p>
<h3 id="drawbacks">Drawbacks</h3>
<p>Even though you can avoid a lot of the common errors by re-using charts across apps, there's still very little sanity on what helm values can contain. Here are some values you can pass through a helm chart to kube and still be accepted:</p>
<ul>
<li>misspelled optional values (silently ignored)</li>
<li>resource requests exceeding largest node (cannot schedule nor vertically auto scale)</li>
<li>resource requests &gt; resource limits (illogical)</li>
<li>out of date secrets (generally causing crashes)</li>
<li>missing health checks / <code>readinessProbe</code> (broken services can rollout)</li>
<li>images and versions that does not exist (fails to install/upgrade)</li>
</ul>
<p>And that's once you've gotten over how frurstrating it can be to write helm templates in the first place.</p>
<h2 id="limitations">Limitations</h2>
<p>While validation is a fixable annoyance, a bigger observation is that these helm values files become a really interesting, but entirely <strong>accidental abstraction</strong>. These files become the canonical representation of your services, but you have no useful logic around it. You have very little validation, almost no definition of what's allowed in there (<code>helm lint</code> is lackluster), you have no process of standardisation, it's hard to test sprawling automation scripts around the values files, and you do not have any sane way of evolving these charts.</p>
<h2 id="main-idea-shipcat">Main idea: <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat"><code>shipcat</code></a></h2>
<p>What if if we could take the general idea that developers just write simplified <em>yaml manifests</em> for their app, but we actually define that API instead? By actually defining the structs we can provide a bunch of security checking and validation on top of it, and we will have a well-defined boundary for automation / ci / dev tools.</p>
<p>By defining all our syntax in a library we can have cli tools for automation and executables running as kube operators using the same definitions. It effectively provides a way for us to versioning our platform.</p>
<p>It also allows us to solve the secret problem. We can extend the manifests with syntax that allows synchronsing secrets from <a rel="noopener" target="_blank" href="https://www.hashicorp.com/products/vault/">Vault</a> at both deploy and validation time.</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>This style of tool is not a revolutionary idea. Last kubecon pretty much everyone had their own wrappers around <code>yaml</code> to help with these problems. Some common examples these days are: <code>kubecfg</code>, <code>ksonnet</code>, <code>flux</code>, <code>helmfile</code>, which all try to help out in this space, but they were all missing most of the sanity we required when we started experimenting at the start of 2018.</p>
<p>Note that this was our first take on adding some validation around kube in a world that had a lot of external config management that didn't plug nicely into kube. It's heavily evolving and not general purpose as it stands. Extra parts of our validation will probably still move to a more declarative format (like <a rel="noopener" target="_blank" href="https://www.openpolicyagent.org/">OPAs</a>) than the raw logic described herein.</p>
<h2 id="manifests">Manifests</h2>
<p>When migrating to kubernetes, the abstraction we settled on was service-level manifests:</p>
<pre data-lang="yaml" class="language-yaml z-code"><code class="language-yaml" data-lang="yaml"><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">webapp</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">image</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">clux/webapp-rs</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-float z-decimal z-yaml">0<span class="z-punctuation z-separator z-decimal z-yaml">.</span>2.0</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">env</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">DATABASE_URL</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">IN_VAULT</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">resources</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">requests</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">cpu</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">100m</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">memory</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">100Mi</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">limits</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">cpu</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">300m</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">memory</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">300Mi</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">replicaCount</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-integer z-decimal z-yaml">2</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">health</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">uri</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/health</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">httpPort</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-integer z-decimal z-yaml">8000</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">regions</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">minikube</span>
<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">metadata</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">contacts</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>Eirik<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">slack</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>@clux<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">team</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">Doves</span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">repo</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">https://github.com/clux/webapp-rs</span>
</span></code></pre>
<p>This encapsulates the most important kube apis that developers should configure themselves, who's responsible for it, what regions it's deployed in, what secrets are needed (notice the <code>IN_VAULT</code> marker), and how resource intensive it is.</p>
<h2 id="strict-syntax">Strict Syntax</h2>
<p>Because these manifests were going to be the entry point for CI pipelines and handle platform specific validation (for medical software), we wanted maximum strictness everywhere and that includes the ability to catch errors before manifests are committed to <code>master</code>.</p>
<p>We lean heavily on <a rel="noopener" target="_blank" href="https://serde.rs/attributes.html">serde's customisable codegeneration</a> to easily encapsulate even the most awkward kube apis - that we want our developers to take advantage of -  and to auto-generate the boilerplate validation around types and spelling errors.</p>
<p>Here's our structs that encapsulate <a rel="noopener" target="_blank" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Role-based access control</a> for applications consuming kube apis:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Serialize<span class="z-punctuation z-separator z-rust">,</span> Deserialize<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">deny_unknown_fields</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Rbac</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> API groups containing resources (defined below)
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">apiGroups</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>AllowedApiGroups<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Resources on which to apply verbs / actions
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">resources</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>AllowedResources<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Actions to be allowed
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">verbs</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>AllowedVerbs<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Serialize<span class="z-punctuation z-separator z-rust">,</span> Deserialize<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">rename_all <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>lowercase<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">AllowedApiGroups</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">rename <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
    Empty<span class="z-punctuation z-separator z-rust">,</span>
    Extensions<span class="z-punctuation z-separator z-rust">,</span>
    Batch<span class="z-punctuation z-separator z-rust">,</span>
    <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">rename <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>babylontech.co.uk<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
    Babylontech<span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Serialize<span class="z-punctuation z-separator z-rust">,</span> Deserialize<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">rename_all <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>lowercase<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">AllowedResources</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    Deployments<span class="z-punctuation z-separator z-rust">,</span>
    ReplicaSets<span class="z-punctuation z-separator z-rust">,</span>
    Jobs<span class="z-punctuation z-separator z-rust">,</span>
    CronJobs<span class="z-punctuation z-separator z-rust">,</span>
    Pods<span class="z-punctuation z-separator z-rust">,</span>
    <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">rename <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>pods/log<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
    PodsSlashLog<span class="z-punctuation z-separator z-rust">,</span>
    ConfigMaps<span class="z-punctuation z-separator z-rust">,</span>
    Namespaces<span class="z-punctuation z-separator z-rust">,</span>
    HorizontalPodAutoscaler<span class="z-punctuation z-separator z-rust">,</span>
    Events<span class="z-punctuation z-separator z-rust">,</span>
    Nodes<span class="z-punctuation z-separator z-rust">,</span>
    RoleBindings<span class="z-punctuation z-separator z-rust">,</span>
    Roles<span class="z-punctuation z-separator z-rust">,</span>
    Secrets<span class="z-punctuation z-separator z-rust">,</span>
    ServiceAccounts<span class="z-punctuation z-separator z-rust">,</span>
    Services<span class="z-punctuation z-separator z-rust">,</span>
    ShipcatManifests<span class="z-punctuation z-separator z-rust">,</span>
    ShipcatConfigs<span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Serialize<span class="z-punctuation z-separator z-rust">,</span> Deserialize<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">serde</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">rename_all <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>lowercase<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">AllowedVerbs</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    List<span class="z-punctuation z-separator z-rust">,</span>
    Get<span class="z-punctuation z-separator z-rust">,</span>
    Watch<span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Notice the awkward empty string having explicit meanings in the kube api, which <code>serde</code> elegantly normalises with a <code>rename</code> field level attribute, but obeying the <code>rename_all</code> container level attribute as an overrideable default.</p>
<p>In other words, <code>serde</code> takes care of most of our validation. It even catches spelling-errors and extraneous types/keys due to the <code>#[serde(deny_unknown_fields)]</code> instruction.</p>
<p>While this goes way beyond what you normally can do with a yaml validator: we can still do better. Every struct can implement a <code>verify</code> function that encapsulates common mistakes that are clearly errors and should be caught before they are sent out to our kube clusters:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Rbac</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">verify</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>apiGroups<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">is_empty</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-support z-macro z-rust">bail!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>RBAC needs to have at least one item in apiGroups<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>resources<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">is_empty</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-support z-macro z-rust">bail!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>RBAC needs to have at least one item in resources<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>verbs<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">is_empty</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-support z-macro z-rust">bail!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>RBAC needs to have at least one item in verbs<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We don't trait these functions because we sometimes pass around some context from other structures to have cross-referencing validation.</p>
<p>Finally, this <code>Rbac</code> struct is attached to our core <a rel="noopener" target="_blank" href="https://babylonhealth.github.io/shipcat/shipcat_definitions/manifest/struct.Manifest.html">Manifest</a> so developers can take advantage of it by simply adding:</p>
<pre data-lang="yaml" class="language-yaml z-code"><code class="language-yaml" data-lang="yaml"><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">rbac</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
<span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">apiGroups</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>extensions<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">resources</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>deployments<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">verbs</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>get<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span><span class="z-punctuation z-separator z-sequence z-yaml">,</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>watch<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span><span class="z-punctuation z-separator z-sequence z-yaml">,</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>list<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span></code></pre>
<p>to their service manifest. That's it. They now have a service that is allowed can watch kube <code>Deployment</code> objects via a generated in-cluster service account token.</p>
<p>In this case, this syntax is a straight translation of the kubernetes API (but leaving out the boilerplate static yaml), and this is often what we do in <code>shipcat</code>.</p>
<p>In some cases, however, we do provide our own simplifying abstractions, but this tends to be for other integrations.</p>
<p>All of our syntax is defined in <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat/blob/master/shipcat_definitions/src/structs/">shipcat/structs</a> so that our developers can easily extend the syntax once we've reached code-review consensus.</p>
<p>Once a new version of <code>shipcat</code> is released, we bump its pin in our <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat/blob/master/examples">configuration repository with all our manifests</a>, and the new syntax + feature becomes availble to developers.</p>
<h2 id="developer-pre-merge-ci-usage">Developer / Pre-merge CI Usage</h2>
<p>Developers can check that their manifests pass validation rules locally, or wait for pre-merge validation on CI:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">shipcat</span></span><span class="z-meta z-function-call z-arguments z-shell"> validate myapp</span>
</span></code></pre>
<p>which will run all the associated rules required by the manifest for this service.</p>
<p>To further check what kube yaml this is generating we have:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">shipcat</span></span><span class="z-meta z-function-call z-arguments z-shell"> template myapp</span>
</span></code></pre>
<p>which is roughly equivalent to:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">shipcat</span></span><span class="z-meta z-function-call z-arguments z-shell"> values myapp</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">helm</span></span><span class="z-meta z-function-call z-arguments z-shell"> template charts/base</span>
</span></code></pre>
<p>We do currently lean on helm charts for generating the complete kube yaml, but this is an implementation detail that only a handful of engineers need to touch as we follow the <a rel="noopener" target="_blank" href="https://www.youtube.com/watch?v=HzJ9ycX1h0c">one chart to rule them all approach</a>. Charts are also linted with <a rel="noopener" target="_blank" href="https://github.com/garethr/kubeva"><code>kubeval</code></a> against all services in all regions during chart upgrades.</p>
<h2 id="upgrade-ci-usage">Upgrade CI Usage</h2>
<p>We currently provide a wrapper around the entire <code>upgrade</code> process with:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">shipcat</span></span><span class="z-meta z-function-call z-arguments z-shell"> apply myapp</span>
</span></code></pre>
<p>and a CI reconciliation wrapper:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">shipcat</span></span><span class="z-meta z-function-call z-arguments z-shell"> cluster helm reconcile</span>
</span></code></pre>
<p>which will wait for the helm release(s) (working around various tiller bugs to do so correctly).</p>
<p>This is an abstraction that is due for a change, however. The <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat/issues/11">tiller dependency is being removed on our end</a>, and meanwhile, <a rel="noopener" target="_blank" href="https://github.com/helm/community/blob/master/helm-v3/000-helm-v3.md">helm 3 is rearchitecting away tiller entirely</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The ability to standardise, version, manage secrets, gradually introduce features to our kube clusters, and have a common point to write automation on top of has been invaluable to us. Huge thanks to <a rel="noopener" target="_blank" href="https://www.rust-lang.org/">rust</a> and <a rel="noopener" target="_blank" href="https://serde.rs/">serde</a> for making it this easy to do. &lt;3</p>
<h2 id="going-further">Going further</h2>
<p>While the core part of shipcat is the <a rel="noopener" target="_blank" href="https://babylonhealth.github.io/shipcat/shipcat_definitions">standardised syntax</a>, we also have a bunch of automation/integrations in the <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat/blob/master/shipcat_cli">shipcat cli</a>, as well as a kubernetes operator; <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat/blob/master/raftcat">raftcat</a> (where we really see code-generation and generics shine). We'll talk about these further another time.</p>
<p>In the mean time, feel free to dig around; <a rel="noopener" target="_blank" href="https://github.com/babylonhealth/shipcat">shipcat is open source</a>. There's also our talk: <a rel="noopener" target="_blank" href="https://www.youtube.com/watch?v=FvKQP7Qnfuc">Babylon Health - Leveraging Kubernetes for global scale</a> from DoxLon2018 for a little more context.</p>

      <nav>
        <div>
          <a href="https://clux.github.io/probes.zola/three-way-charm/">&#8249; Three Way Charms</a>
        </div>
        <div>
          <a href="https://clux.github.io/probes.zola/colemak-switchover/"> Colemak Switchover &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">

      <div class="blockdiv sticky">
        <a class="b s150" href="#">Index</a>
        <div>
          <a href="#kubernetes-api">Kubernetes API</a>
        </div>
        <div>
          <a href="#helm">Helm</a>
        </div>
        <div class="hpad">
          <a href="#drawbacks"><small>- Drawbacks</small></a>
        </div>
        <div>
          <a href="#limitations">Limitations</a>
        </div>
        <div>
          <a href="#main-idea-shipcat">Main idea: shipcat</a>
        </div>
        <div>
          <a href="#disclaimer">Disclaimer</a>
        </div>
        <div>
          <a href="#manifests">Manifests</a>
        </div>
        <div>
          <a href="#strict-syntax">Strict Syntax</a>
        </div>
        <div>
          <a href="#developer-pre-merge-ci-usage">Developer &#x2F; Pre-merge CI Usage</a>
        </div>
        <div>
          <a href="#upgrade-ci-usage">Upgrade CI Usage</a>
        </div>
        <div>
          <a href="#conclusion">Conclusion</a>
        </div>
        <div>
          <a href="#going-further">Going further</a>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <hr />
    <div class="c">
      <nav><div><a type="application/atom+xml" href="https://clux.github.io/probes.zola/atom.xml" target="_blank" title="probes Atom/RSS Feed"><i type="Button" class="svg rss" title="probes Atom/RSS Feed"></i></a><a href="https://hachyderm.io/@clux" target="_blank" title="Mastodon" rel="me"><i type="Button" class="svg mastodon" title="Mastodon"></i></a><a href="https://www.linkedin.com/in/🗑-eirik-albrigtsen-b279863a/" target="_blank" title="LinkedIn"><i type="Button" class="svg linkedin" title="LinkedIn"></i></a><a href="https://github.com/clux/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a><a href="https://discord.com/tokio/" target="_blank" title="Discord"><i type="Button" class="svg discord" title="Discord"></i></a><a href="https://www.youtube.com/channel&#x2F;UCLpykMxkxuPUR9CciheipZg" target="_blank" title="YouTube"><i type="Button" class="svg youtube" title="YouTube"></i></a><a href="https://github.com/sponsors/clux/" target="_blank" title="GitHub Sponsor"><i type="Button" class="svg github-sponsor" title="GitHub Sponsor"></i></a></div></nav>
      <nav>
        <a class="s90" href="https://clux.github.io/probes.zola/about/"> About </a>
        <a class="s90" href="https://clux.github.io/probes.zola/privacy/"> Privacy </a>
        <a class="s90" href="https://clux.github.io/probes.zola/sitemap.xml" target="_blank"> Sitemap </a>
      </nav>
      <p class="s90">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>
